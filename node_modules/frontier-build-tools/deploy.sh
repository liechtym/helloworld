#!/bin/bash

echo "Deploy the app"

source $HOME/.nvm/nvm.sh

TARGET_USER=${APP_SUFFIX:-prod}

# Setup app
echo "Setup the heroku app"
cake -u $TARGET_USER -t $TARGET_USER -e production deploy:setup

# Deploy app
# Use 'prod' unless build environment overrides APP_SUFFIX environment variable
DEPLOY_LOG=deploy_results.txt
cake -u $TARGET_USER deploy | tee $DEPLOY_LOG

DID_DEPLOY=`egrep "Heroku (promote|deploy) successful" -c $DEPLOY_LOG`
rm $DEPLOY_LOG

if [ "$DID_DEPLOY" == 0 ]
then
  echo "Exiting build because it failed to deploy to heroku"
  exit 1
fi
