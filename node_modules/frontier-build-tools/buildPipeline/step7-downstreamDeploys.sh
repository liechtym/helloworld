################################################################################
#
# This is the seventh step of the build process
# This file will:
#   1. Create and promote any downstreams from fs-$APP_NAME-prod
#
################################################################################

# fail fast
set -o errexit
set -o pipefail


# Setting the Current
CURRENT_ENV="prod"

# Get the new Downstream (if any)
DOWNSTREAM_APP=`heroku config:get DOWNSTREAM_APP -a fs-$APP_NAME-prod`

while [[ -n $DOWNSTREAM_APP ]]; do
  DOWNSTREAM_ENV=`echo $DOWNSTREAM_APP | sed s/fs-$APP_NAME-//g`

  # Create the new downstream in the pipeline if not exists
  heroku pipeline:add fs-$APP_NAME-$DOWNSTREAM_ENV -a fs-$APP_NAME-$CURRENT_ENV

  # Assuming that everything downstream from prod is NODE_ENV=production
  cake -u $DOWNSTREAM_ENV -t $DOWNSTREAM_ENV -e production deploy:setup

  # Promote from the Current
  heroku pipeline:promote -a fs-$APP_NAME-$CURRENT_ENV

  # Set the new Current
  CURRENT_ENV=$DOWNSTREAM_ENV

  # Get the new Downstream (if any)
  DOWNSTREAM_APP=`heroku config:get DOWNSTREAM_APP -a fs-$APP_NAME-$CURRENT_ENV`
done