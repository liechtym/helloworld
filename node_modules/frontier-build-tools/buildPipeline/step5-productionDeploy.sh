################################################################################
#
# This is the fifth step of the build process
# This file will:
#   1. Promote the code from -beta to -prod
#   2. Perform a smoke test against fs-$APP_NAME-prod.herokuapp.com
#   3. (optional) Perform a smoke test against another (domain-mounted) url ($PROD_SMOKE_URL)
#
################################################################################

# fail fast
set -o errexit
set -o pipefail


############################
#          PROD            #
############################

# Add environment variables to -prod
echo "Update prod app's env vars"
cake -u prod -t prod -e production deploy:setup



# Ensure that the correct downstream is set
heroku pipeline:add fs-${APP_NAME}-prod -a fs-${APP_NAME}-beta > output.txt
DS_RESULT=`cat output.txt`
rm output.txt

dsError='Downstream app already configured'
if [[ "$DS_RESULT" == *"$dsError"* ]]
then
  echo "Exiting build because beta app downstream was already set incorrectly"
  exit 1
fi



# Promote from -beta to -prod
heroku pipeline:promote -a fs-$APP_NAME-beta



# test that the app responds via https
curl https://fs-$APP_NAME-prod.herokuapp.com | tee output.txt
APP_RESPONSE=`cat output.txt`
rm output.txt

appError='Application Error'
if [[ "$APP_RESPONSE" == *"$appError"* ]]
then
  echo "Exiting build because prod app failed to startup on heroku"
  exit 1
fi


# Smoke test against an optional domain-mounted url
if [ ! -z "$PROD_SMOKE_URL" ]; then

  echo "Starting a smoke test by loading $PROD_SMOKE_URL"
  curl $PROD_SMOKE_URL > output.txt
  APP_RESPONSE=`cat output.txt`
  rm output.txt
  echo "Finished smoke test"

  appError='You have encountered a broken link or a page that does not exist'
  if [[ "$APP_RESPONSE" == *"$appError"* ]]
  then
    echo "Exiting build because app failed to startup against parked url"
    exit 1
  fi

fi
