################################################################################
#
# This is the second step of the build process
# This file will:
#   1. (optionally) Run Regression tests against references from a local path
#
################################################################################

# fail fast
set -o errexit
set -o pipefail

function runRegressionScript() {
  local scriptToRun=$1
  local referenceId=$2
  heroku run "([ ! -f $scriptToRun ] || $scriptToRun) && echo Success" -a fs-$APP_NAME-$referenceId | tee output.txt
  REGRESSION_RESULT=`tail -1 output.txt | grep Success | tr -d " "`
  rm output.txt

  if [[ "$REGRESSION_RESULT" != "Success" ]]
  then
    echo "Exiting build because app failed regression tests on heroku"
    exit 1
  fi
}

function runRegressionScriptsForReference() {
  local referenceScriptsVariable=$1
  local referenceId=$2
  IFS=','
  for testScript in $referenceScriptsVariable
  do
    runRegressionScript $testScript $referenceId
  done
}

if [ ! -z "$INTEGRATION_REGRESSION_TEST_SCRIPTS" ]; then
  echo "Running regression test scripts on the Integration reference"
  runRegressionScriptsForReference "$INTEGRATION_REGRESSION_TEST_SCRIPTS" "int"
fi

if [ ! -z "$BETA_REGRESSION_TEST_SCRIPTS" ]; then
  echo "Running regression test scripts on the Beta reference"
  runRegressionScriptsForReference "$BETA_REGRESSION_TEST_SCRIPTS" "beta"
fi

if [ ! -z "$PRODUCTION_REGRESSION_TEST_SCRIPTS" ]; then
  echo "Running regression test scripts on the Production reference"
  runRegressionScriptsForReference "$PRODUCTION_REGRESSION_TEST_SCRIPTS" "prod"
fi