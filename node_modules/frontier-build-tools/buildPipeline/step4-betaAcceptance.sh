################################################################################
#
# This is the fourth step of the build process
# This file will:
#   1. (optionally) Run Acceptance tests against fs-$APP_NAME-beta from a local path ($ACCEPTANCE_PATH)
#
################################################################################

# fail fast
set -o errexit
set -o pipefail

function runAcceptanceScript() {
  local scriptToRun=$1
  heroku run "([ ! -f $scriptToRun ] || $scriptToRun) && echo Success" -a fs-$APP_NAME-beta | tee output.txt
  ACCEPTANCE_RESULT=`tail -1 output.txt | grep Success | tr -d " "`
  rm output.txt

  if [[ "$ACCEPTANCE_RESULT" != "Success" ]]
  then
    echo "Exiting build because app failed acceptance tests on heroku"
    exit 1
  fi
}

# Run path-based acceptance tests
if [ ! -z "BETA_ACCEPTANCE_TEST_SCRIPTS" ]; then

  IFS=','
  for testScript in $BETA_ACCEPTANCE_TEST_SCRIPTS
  do
    runAcceptanceScript $testScript
  done
fi
